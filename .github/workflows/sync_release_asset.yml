name: Sync release asset to FUSInstrumentsFolder

on:
  release:
    types: [published]


jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: getrel
        uses: actions/github-script@v6
        with:
          script: |
            const rel = context.payload.release;
            return {
              tag_name: rel.tag_name,
              assets: rel.assets.map(a => ({
                name: a.name,
                download_url: a.url,
                browser_download_url: a.browser_download_url
              }))
            };

      - name: Pick asset name
        id: pick
        run: |
          # Write the release info JSON to a file safely
          echo '${{ toJson(steps.getrel.outputs) }}' > /tmp/release_info.json

          # Use Python to read the file and pick the asset
          python3 - <<'PY'
          import json
          import os
          import sys
          
          try:
              with open("/tmp/release_info.json", "r", encoding="utf-8") as f:
                  data = json.load(f)
          except Exception as e:
              print(f"Failed to read JSON: {e}", file=sys.stderr)
              sys.exit(1)
          
          assets = data.get("assets", [])
          exts = [".zip", ".exe", ".msi"]
          pick = None
          for ext in exts:
              for a in assets:
                  name = a.get("name","")
                  if name.lower().endswith(ext):
                      pick = a
                      break
              if pick:
                  break
          if not pick and assets:
              pick = assets[0]
          if not pick:
              print("No asset found", file=sys.stderr)
              sys.exit(1)
          
          asset_name = pick.get("name")
          asset_api_url = pick.get("download_url") or pick.get("browser_download_url") or ""
          
          # Write outputs for GitHub Actions
          gout = os.environ.get("GITHUB_OUTPUT")
          if gout:
              with open(gout, "a") as f:
                  f.write(f"asset_name={asset_name}\n")
                  f.write(f"asset_api_url={asset_api_url}\n")
          
          print(f"Selected asset: {asset_name}")
          PY

      - name: Download asset (stream)
        run: |
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/octet-stream" \
                 -o "${{ steps.pick.outputs.asset_name }}" \
                 "${{ steps.pick.outputs.asset_api_url }}"

      - name: Upload to target repo (delete existing and upload)
        env:
          TARGET_REPO: fusinstruments/FUSInstrumentsFolder
          TARGET_PAT: ${{ secrets.TARGET_REPO_PAT }}
        run: |
          set -e
          FNAME="${{ steps.pick.outputs.asset_name }}"
          TAG="${{ steps.getrel.outputs_tag_name }}"

          # Get target release by tag
          r=$(curl -s -H "Authorization: token $TARGET_PAT" \
               "https://api.github.com/repos/$TARGET_REPO/releases/tags/$TAG" || true)

          if echo "$r" | grep -q '"id":'; then
              REL_ID=$(echo "$r" | jq -r .id)
              UPLOAD_URL=$(echo "$r" | jq -r .upload_url)
          else
              create=$(curl -s -X POST -H "Authorization: token $TARGET_PAT" \
                -H "Content-Type: application/json" \
                -d "{\"tag_name\":\"$TAG\",\"name\":\"$TAG\",\"body\":\"Automated sync from AUREUS_V2\",\"prerelease\":false}" \
                "https://api.github.com/repos/$TARGET_REPO/releases")
              REL_ID=$(echo "$create" | jq -r .id)
              UPLOAD_URL=$(echo "$create" | jq -r .upload_url)
          fi

          # Delete existing asset if present
          ASSETS=$(curl -s -H "Authorization: token $TARGET_PAT" \
                   "https://api.github.com/repos/$TARGET_REPO/releases/$REL_ID/assets")
          EXISTING_ID=$(echo "$ASSETS" | jq -r --arg NAME "$FNAME" '.[] | select(.name==$NAME) | .id' || true)
          if [ -n "$EXISTING_ID" ] && [ "$EXISTING_ID" != "null" ]; then
              curl -s -X DELETE -H "Authorization: token $TARGET_PAT" \
                   "https://api.github.com/repos/$TARGET_REPO/releases/assets/$EXISTING_ID"
          fi

          # Upload new asset
          UPLOAD_BASE=$(echo "$UPLOAD_URL" | sed 's/{.*//')
          mime=$(python3 -c "import mimetypes; print(mimetypes.guess_type('$FNAME')[0] or 'application/octet-stream')")
          curl -s --data-binary @"$FNAME" \
               -H "Authorization: token $TARGET_PAT" \
               -H "Content-Type: $mime" \
               "$UPLOAD_BASE?name=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$FNAME'''))")"
          echo "Upload done"
